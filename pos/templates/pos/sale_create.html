{% extends 'pos/base.html' %}{% block content %}
<h2>New Sale</h2>
<div class="card">
  <label>Scan / Enter product SKU:</label>
  <input id="barcode_input" placeholder="Scan barcode or type SKU then press Enter">
  <label>Qty:</label>
  <input id="barcode_qty" type="number" value="1" min="1" style="width:80px;">
  <button id="add_by_sku" class="btn">Add by SKU</button>
  <p><small>Tip: USB barcode scanners act like a keyboard â€” they type the SKU then press Enter.</small></p>
</div>
<form method="post" id="sale_form">{% csrf_token %}
  <fieldset class="card"><legend>Sale</legend>{{ form.as_p }}</fieldset>
  <fieldset class="card"><legend>Items</legend>{{ formset.management_form }}<table class="table" id="items_table"><thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Item Discount %</th><th>Delete</th></tr></thead><tbody>{% for f in formset %}<tr class="form-row"><td>{{ f.product }}</td><td>{{ f.quantity }}</td><td>{{ f.unit_price }}</td><td>{{ f.discount_percent }}</td><td>{{ f.DELETE }}</td></tr>{% endfor %}</tbody></table><p><small>Add more rows by increasing "extra" in formset (code) for now.</small></p></fieldset>
  <fieldset class="card"><legend>Payment</legend>{{ payment_form.as_p }}</fieldset>
  <button class="btn" type="submit">Save Sale</button>
</form>

<script>
async function fetchProductBySKU(sku){
  const resp = await fetch('/api/products/?sku=' + encodeURIComponent(sku));
  const data = await resp.json();
  return data.results && data.results.length ? data.results[0] : null;
}
function getTotalForms(){ return document.querySelector('input[name$="-TOTAL_FORMS"]'); }
function incrementTotalForms(){ const tf=getTotalForms(); tf.value = parseInt(tf.value)+1; return parseInt(tf.value)-1; }
function addRowForProduct(product, qty=1){
  const index = incrementTotalForms();
  const tbody = document.querySelector('#items_table tbody');
  const tr = document.createElement('tr'); tr.classList.add('form-row');
  tr.innerHTML = `
    <td><input type="hidden" name="items-${index}-id" value=""><select name="items-${index}-product"><option value="${product.id}" selected>${product.name} (${product.sku})</option></select></td>
    <td><input type="number" name="items-${index}-quantity" value="${qty}" min="1"></td>
    <td><input type="text" name="items-${index}-unit_price" value="${product.price}"></td>
    <td><input type="text" name="items-${index}-discount_percent" value="0"></td>
    <td><input type="checkbox" name="items-${index}-DELETE"></td>`;
  tbody.appendChild(tr);
}
document.getElementById('add_by_sku').addEventListener('click', async function(e){e.preventDefault(); const sku=document.getElementById('barcode_input').value.trim(); const qty=parseInt(document.getElementById('barcode_qty').value||'1'); if(!sku) return alert('Enter SKU'); const p = await fetchProductBySKU(sku); if(!p) return alert('Product not found for SKU: ' + sku); addRowForProduct(p, qty); document.getElementById('barcode_input').value='';});
document.getElementById('barcode_input').addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('add_by_sku').click(); } });
</script>
{% endblock %}
